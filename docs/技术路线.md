技术路线：

# 渲染框架

## 模型加载和绘制

glTF：glTF是有Khronos Group设计的一种用于高效传输3D场景内容的场景描述格式。glTF核心是一个描述了3D场景的结构和内容的JSON文件。
tinygltf是一个支持加载glTF场景的开源库，我们使用tinygltf库加载3D场景中的模型，材质，贴图等数据


## 光源

现实世界中，我们有多种类型的光源，如太阳光，灯等。在实时渲染中，我们通常使用三种类型的光源来近似。


#### 方向光

方向光模拟从无限远的源头处发出的光线。这意味着此光源投射出的阴影均为平行，因此适用于模拟太阳光。它的所有光线都有着相同的方向，与光源的位置是没有关系的。对于方向光，我们定义方向参数，通过此参数计算着色。


#### 点光源

除了方向光，世界中还有像灯泡，火把的光源，这种光源处于世界中某一个位置的光源，会朝所有方向发光，我们称之为点光源。对于点光源，我们定义光源的位置和衰减半径，亮度随着物体到光源距离的平方衰减，在衰减半径外的物体将不会被照亮。


#### 聚光灯

对于聚光灯，我们定义位置，方向，内锥角，外锥角共4个参数。在内锥角内部，亮度不会衰减，在外锥角外部，物体不会被照亮，聚光灯同时也满足和点光源相同的反比平方衰减的定律。


## 着色

我们采用基于物理的着色模型，这也是工业界的常见做法，我们不在此赘述基于物理着色的原理和推导，在渲染框架中，我们采用Cook-Torrance微表面brdf，从glTF场景中读取albedo，normal，metallic，roughness贴图并计算着色。


## 阴影

阴影是光线被阻挡的结果；当一个光源的光线由于其他物体的阻挡不能够达到一个物体的表面的时候，那么这个物体就在阴影中了。阴影能够使场景看起来真实得多，并且可以让观察者获得物体之间的空间位置关系。Shadow Mapping是一种在实时渲染中绘制阴影的算法，它原理简单，相对较容易实现。
Shadow Mapping的原理十分简单，我们以光源的位置为视角进行渲染，我们能看到的东西都将被点亮，看不见的一定是在阴影之中了。我们在渲染管线中添加一个pass在着色之前，在这个pass中，我们在每个动态光源的视角渲染一遍场景，并将深度存成一张阴影贴图。在着色的pass中，对于每一个着色点，我们将着色点的世界坐标乘光源的视图矩阵，转换到光源的视角，比较和阴影贴图的深度，便可以判断着色点是否处于阴影中。


## 后处理

### Gamma矫正

由于一些历史遗留原因，当下显示器出厂时都会带有一个Gamma值，这会将我们最终输出的颜色变暗，因此在计算着色后，我们需要对计算出的颜色进行Gamma矫正，Gamma校正的思路是在最终的颜色输出上应用显示器Gamma的倒数，一般这个值是2.2。我们在颜色显示到监视器的时候把每个颜色输出都加上这个翻转的Gamma曲线，这样应用了监视器Gamma以后最终的颜色将会变为线性的。我们所得到的中间色调就会更亮，所以虽然监视器使它们变暗，但是我们又将其平衡回来了。


# 算法设计

## 大气散射

![](figs/2.png)

大气是一种参与性介质，对于参与性介质，要考虑粒子的散射行为。当光线打到粒子上时，会有一部分光子被吸收，另一部分被弹射出。如果原本方向不朝视线方向的光被粒子弹射后方向是视线方向，这部分光会增强亮度，如果原本方向朝视线方向的光被散射至其他方向，这部分光会减弱亮度。

另一个要素是粒子将如何散射光线，不同粒子散射光线的方式也不同。两种常见的形式为瑞丽散射和米氏散射。这两种散射可以预测不同大小的粒子如何散射光线。前者模拟了构成大部分空气的氧气分子和氮气分子如何散射光。后者模拟了光如何被在悬浮在低层大气中的较大化合物上散射，例如花粉，灰尘和污染物。


## 相位函数

相位函数描述了对于给定入射方向，散射到出射方向的光的强度，这与材质中的brdf类似

瑞利散射对于前向和后向的散射强度相同，观测结果由下图给出

![](figs/1.png)

我们可以用一个关于θ的函数描述瑞利散射的相位函数来近似

$p(\theta)=\frac{3}{16\pi}(1+\cos^2(\theta))$

![](figs/3.png)

米氏散射则更加复杂，不同形状和不同大小的粒子会造成不同的散射结果，常用Henyey-Greenstein相位函数来近似，其中$g$为散射的平均角度，$-1<g<1$。

$p(\theta)=\frac{1-g^2}{4\pi(1+g^2-2g\cos(theta))^{\frac{3}{2}}}$

下图是对应不同g值的用Henyey-Greenstein相位函数近似得到的图像

![](figs/4.png)

## 渲染方程

对于参与性介质的渲染，我们要解一个视线沿着介质路径的积分式。这个积分式如下所示。

$L(x,\omega) = \int^D_0{e^{-\int_x^{x'}\sigma_t(t)dt}\sigma_s(x')}[\int_{\Omega 4 \pi} p(\omega,\omega') L_i(x',\omega') d\omega']dx'
$

$\tau(x,x')=$

其结果为表示在距离$x$处，沿出射方向$\omega$，沿介质中步进$D$距离的辐射度。

其中，$[\int_{\Omega 4 \pi} p(\omega,\omega')L_i(x',\omega')d\omega']$表示散射后出射方向为$\omega$的光在球面上的积分。${e^{-\int_x^{x'}\sigma_t(t)dt}\sigma_s(x')}$为光在介质从$x$中到$x'$的衰减系数。


## 数据模型

在渲染方程中，未知量为距离$x$，出射方向$\omega$。如果我们知道着色点的位置，便可求解这两个未知量，我们可以在着色前添加一个Geometry Pass，将深度存成一张贴图，在使用的时候通过每个像素点的深度恢复出着色点的三维坐标。得到着色点的三维坐标后我们可以根据视点的三维坐标计算出距离$x$，出射方向$\omega$。之后我们通过光线步进的方法计算渲染方程。

